name: ðŸš¨ GHAS Security Alerts to Slack

on:
  # Trigger on code changes that might introduce vulnerabilities
  push:
    branches: [main, master, develop]

  pull_request:
    branches: [main, master, develop]

  # Check for new alerts periodically
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Test message to send to Slack'
        required: false
        default: 'ðŸ§ª Testing GHAS-to-Slack integration'
      check_type:
        description: 'Type of security check'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - code-scanning
          - dependabot
          - secrets

jobs:
  notify-slack:
    name: ðŸ”” Send Security Alert to Slack
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‹ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Check for Security Alerts
        id: alert-details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Set default values
          ALERT_COUNT=0
          ALERT_TYPE="No Alerts"
          SEVERITY="info"
          ALERT_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/security"
          MESSAGE="âœ… No new security alerts detected"
          CHECK_TYPE="${{ github.event.inputs.check_type || 'all' }}"

          # Check CodeQL/Code Scanning alerts
          if [[ "$CHECK_TYPE" == "all" || "$CHECK_TYPE" == "code-scanning" ]]; then
            echo "ðŸ” Checking CodeQL alerts..."
            CODE_ALERTS=$(gh api repos/${{ github.repository }}/code-scanning/alerts --jq '.[] | select(.state=="open")' 2>/dev/null || echo "[]")
            if [[ "$CODE_ALERTS" != "[]" && "$CODE_ALERTS" != "" ]]; then
              CODE_COUNT=$(echo "$CODE_ALERTS" | jq -r '. | length' 2>/dev/null || echo "0")
              if [[ "$CODE_COUNT" -gt 0 ]]; then
                CRITICAL_COUNT=$(echo "$CODE_ALERTS" | jq -r '[.[] | select(.rule.security_severity_level=="critical")] | length' 2>/dev/null || echo "0")
                HIGH_COUNT=$(echo "$CODE_ALERTS" | jq -r '[.[] | select(.rule.security_severity_level=="high")] | length' 2>/dev/null || echo "0")

                ALERT_COUNT=$((ALERT_COUNT + CODE_COUNT))
                ALERT_TYPE="Code Scanning"

                if [[ "$CRITICAL_COUNT" -gt 0 ]]; then
                  SEVERITY="critical"
                  MESSAGE="ðŸš¨ **CRITICAL**: $CRITICAL_COUNT critical CodeQL alerts found!"
                elif [[ "$HIGH_COUNT" -gt 0 ]]; then
                  SEVERITY="high"
                  MESSAGE="âš ï¸ **HIGH**: $HIGH_COUNT high severity CodeQL alerts found!"
                else
                  SEVERITY="medium"
                  MESSAGE="ðŸ” **CodeQL**: $CODE_COUNT security alerts detected"
                fi
              fi
            fi
          fi

          # Check Dependabot alerts
          if [[ "$CHECK_TYPE" == "all" || "$CHECK_TYPE" == "dependabot" ]]; then
            echo "ðŸ“¦ Checking Dependabot alerts..."
            DEP_ALERTS=$(gh api repos/${{ github.repository }}/dependabot/alerts --jq '.[] | select(.state=="open")' 2>/dev/null || echo "[]")
            if [[ "$DEP_ALERTS" != "[]" && "$DEP_ALERTS" != "" ]]; then
              DEP_COUNT=$(echo "$DEP_ALERTS" | jq -r '. | length' 2>/dev/null || echo "0")
              if [[ "$DEP_COUNT" -gt 0 ]]; then
                CRITICAL_DEP=$(echo "$DEP_ALERTS" | jq -r '[.[] | select(.security_advisory.severity=="critical")] | length' 2>/dev/null || echo "0")
                HIGH_DEP=$(echo "$DEP_ALERTS" | jq -r '[.[] | select(.security_advisory.severity=="high")] | length' 2>/dev/null || echo "0")

                ALERT_COUNT=$((ALERT_COUNT + DEP_COUNT))
                if [[ "$ALERT_TYPE" == "No Alerts" ]]; then
                  ALERT_TYPE="Dependabot"
                else
                  ALERT_TYPE="Multiple"
                fi

                if [[ "$CRITICAL_DEP" -gt 0 && "$SEVERITY" != "critical" ]]; then
                  SEVERITY="critical"
                  MESSAGE="ðŸš¨ **CRITICAL**: $CRITICAL_DEP critical dependency vulnerabilities!"
                elif [[ "$HIGH_DEP" -gt 0 && "$SEVERITY" != "critical" ]]; then
                  SEVERITY="high"
                  MESSAGE="âš ï¸ **HIGH**: $HIGH_DEP high severity dependencies vulnerable!"
                elif [[ "$SEVERITY" == "info" ]]; then
                  SEVERITY="medium"
                  MESSAGE="ðŸ“¦ **Dependabot**: $DEP_COUNT vulnerable dependencies detected"
                fi
              fi
            fi
          fi

          # For manual testing
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ALERT_TYPE="Test"
            MESSAGE="${{ github.event.inputs.test_message }}"
            SEVERITY="info"
          fi

          # Set severity color for Slack
          case "$SEVERITY" in
            critical) COLOR="#FF0000" ;;
            high) COLOR="#FF6600" ;;
            medium) COLOR="#FFAA00" ;;
            low) COLOR="#FFDD00" ;;
            info) COLOR="#36A64F" ;;
            *) COLOR="#808080" ;;
          esac

          echo "alert_count=$ALERT_COUNT" >> $GITHUB_OUTPUT
          echo "alert_type=$ALERT_TYPE" >> $GITHUB_OUTPUT
          echo "severity=$SEVERITY" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "alert_url=$ALERT_URL" >> $GITHUB_OUTPUT
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

          # Only send notification if alerts found or manual test
          if [[ "$ALERT_COUNT" -gt 0 || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_notify=true" >> $GITHUB_OUTPUT
          else
            echo "should_notify=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš¨ Send Slack Notification
        if: steps.alert-details.outputs.should_notify == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ðŸš¨ GHAS Security Alert - ${{ steps.alert-details.outputs.alert_type }}",
              "attachments": [
                {
                  "color": "${{ steps.alert-details.outputs.color }}",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "ðŸš¨ Security Alert: ${{ steps.alert-details.outputs.severity }} Severity"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Repository:*\n${{ github.repository }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Alert Type:*\n${{ steps.alert-details.outputs.alert_type }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Severity:*\n${{ steps.alert-details.outputs.severity }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:*\n${{ github.ref_name }}"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "${{ steps.alert-details.outputs.message }}"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "ðŸ” View Alert"
                          },
                          "url": "${{ steps.alert-details.outputs.alert_url }}"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "ðŸ“Š View Security Tab"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/security"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "â° Detected at: ${{ github.event.created_at || github.run_started_at }} | ðŸ¤– Powered by GHAS"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ðŸ“Š Log Alert Summary
        run: |
          echo "## ðŸš¨ Security Alert Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Alert Type**: ${{ steps.alert-details.outputs.alert_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Severity**: ${{ steps.alert-details.outputs.severity }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Alert URL**: ${{ steps.alert-details.outputs.alert_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Notification sent to Slack**: âœ…" >> $GITHUB_STEP_SUMMARY
